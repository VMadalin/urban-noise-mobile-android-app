# Android
# Build your Android project with Gradle.
# Add steps that test, sign, and distribute the APK, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/android

name: Scheduled

schedules:
  - cron: "0 12 * * 0"
    displayName: Weekly Scheduled Tasks
    branches:
      include:
        - master
    always: true

pool:
  vmImage: 'macos-latest'

steps:

  # DependencyUpdates
  - task: Gradle@2
    displayName: DependencyUpdates
    inputs:
      workingDirectory: ''
      gradleWrapperFile: 'gradlew'
      gradleOptions: '-Xmx3072m'
      publishJUnitResults: false
      testResultsFiles: '**/TEST-*.xml'
      tasks: 'dependencyUpdates'

  # Publish DependencyUpdates
  - task: PublishPipelineArtifact@1
    displayName: Publish DependencyUpdates
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/build/dependencyUpdates'
      publishLocation: 'pipeline'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        function Send-SlackMessage {
        param (
        [Parameter(Mandatory=$true, Position=0)]$Text,
        [Parameter(Mandatory=$true, Position=1)]$Url
        )
        $body= @"
        {
          "username": "Loading Bay",
          "text": "MESSAGE_TEXT",
          "icon_emoji":":rolled_up_newspaper:"
        }
        "@

          Invoke-WebRequest -Method Post -Uri $Url -Body $body.Replace("MESSAGE_TEXT","$Text") -ContentType 'application/json'
        }
        Write-Host "Sending slack message for BUILD: $($env:BUILD_BUILDID)"

        Send-SlackMessage "Test WEBHOOK" "$($env:SLACK_WEBHOOK)"

